
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì„œìš¸ ì§€í•˜ì²  ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        #map { height: 100vh; width: 100vw; }
        .legend {
            background: white;
            padding: 10px;
            line-height: 1.5em;
        }
        .legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([37.5665, 126.9780], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const lineColors = {
            "1í˜¸ì„ ": "#0052A4", "2í˜¸ì„ ": "#009D3E", "3í˜¸ì„ ": "#EF7C1C",
            "4í˜¸ì„ ": "#00A5DE", "5í˜¸ì„ ": "#996CAC", "6í˜¸ì„ ": "#CD7C2F",
            "7í˜¸ì„ ": "#747F00", "8í˜¸ì„ ": "#E6186C"
        };

        const iconColors = {
            "1í˜¸ì„ ": "blue", "2í˜¸ì„ ": "green", "3í˜¸ì„ ": "orange",
            "4í˜¸ì„ ": "lightblue", "5í˜¸ì„ ": "purple", "6í˜¸ì„ ": "darkred",
            "7í˜¸ì„ ": "cadetblue", "8í˜¸ì„ ": "pink"
        };

        const trainMarkers = {};

        function updateTrains() {
            fetch('/api/trains')
                .then(res => res.json())
                .then(data => {
                    for (let key in trainMarkers) {
                        map.removeLayer(trainMarkers[key]);
                    }

                    data.forEach(train => {
                        const key = train.trainNo;
                        const color = iconColors[train.line] || "gray";
                        const icon = L.divIcon({
                            html: `<i class="fas fa-train" style="color:white;"></i>`,
                            className: `train-icon-${train.line}`,
                            iconSize: [20, 20]
                        });

                        const marker = L.marker([train.lat, train.lon], { icon: icon })
                            .bindPopup(`<b>${train.line}</b><br>ğŸš†${train.trainNo}<br>${train.station}<br>â†’ ${train.dest}`);
                        marker.addTo(map);
                        trainMarkers[key] = marker;
                    });
                });
        }

        fetch('/api/stations')
            .then(res => res.json())
            .then(data => {
                const grouped = {};
                data.forEach(st => {
                    if (!grouped[st.í˜¸ì„ ëª…]) grouped[st.í˜¸ì„ ëª…] = [];
                    grouped[st.í˜¸ì„ ëª…].push(st);
                });

                Object.keys(grouped).forEach(line => {
                    const color = lineColors[line] || "#888";
                    const coords = grouped[line]
                        .sort((a, b) => a['ê³ ìœ ì—­ë²ˆí˜¸(ì™¸ë¶€ì—­ì½”ë“œ)'] - b['ê³ ìœ ì—­ë²ˆí˜¸(ì™¸ë¶€ì—­ì½”ë“œ)'])
                        .map(st => [st.ìœ„ë„, st.ê²½ë„]);

                    coords.forEach(st => {
                        L.circleMarker(st, {
                            radius: 4,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.8
                        }).addTo(map);
                    });

                    if (coords.length > 1) {
                        L.polyline(coords, { color: color, weight: 3, opacity: 0.5 }).addTo(map);
                    }
                });

                updateTrains();
                setInterval(updateTrains, 10000); // 10ì´ˆë§ˆë‹¤ ê°±ì‹ 
            });
    </script>
</body>
</html>
