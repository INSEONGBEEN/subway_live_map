let map;
let trainMarkers = {};  // trainNo ê¸°ì¤€ìœ¼ë¡œ ë§ˆì»¤ ì¶”ì 

const lineColors = {
    "1í˜¸ì„ ": "blue",
    "2í˜¸ì„ ": "green",
    "3í˜¸ì„ ": "orange",
    "4í˜¸ì„ ": "lightblue",
    "5í˜¸ì„ ": "purple",
    "6í˜¸ì„ ": "darkred",
    "7í˜¸ì„ ": "cadetblue",
    "8í˜¸ì„ ": "pink"
};

const manualOrders = {
  "1í˜¸ì„ _ë„ë´‰ì‚°-ì˜¨ìˆ˜": [
    "ë„ë´‰ì‚°", "ë„ë´‰", "ë°©í•™", "ì°½ë™", "ë…¹ì²œ", "ì›”ê³„", "ê´‘ìš´ëŒ€", "ì„ê³„",
    "ì‹ ì´ë¬¸", "ì™¸ëŒ€ì•", "íšŒê¸°", "ì²­ëŸ‰ë¦¬", "ì œê¸°ë™", "ì‹ ì„¤ë™", "ë™ë¬˜ì•", "ë™ëŒ€ë¬¸",
    "ì¢…ë¡œ5ê°€", "ì¢…ë¡œ3ê°€", "ì¢…ê°", "ì‹œì²­", "ì„œìš¸", "ë‚¨ì˜", "ìš©ì‚°", "ë…¸ëŸ‰ì§„",
    "ëŒ€ë°©", "ì‹ ê¸¸", "ì˜ë“±í¬", "ì‹ ë„ë¦¼", "êµ¬ë¡œ", "êµ¬ì¼", "ê°œë´‰", "ì˜¤ë¥˜ë™", "ì˜¨ìˆ˜"
  ],
  "1í˜¸ì„ _êµ¬ë¡œ-ê¸ˆì²œêµ¬ì²­": [
    "êµ¬ë¡œ", "ê°€ì‚°ë””ì§€í„¸ë‹¨ì§€", "ë…ì‚°", "ê¸ˆì²œêµ¬ì²­"
  ],
  
  "2í˜¸ì„ _ë‚´ì„ ": ["ì‹œì²­", "ì„ì§€ë¡œì…êµ¬", "ì„ì§€ë¡œ3ê°€", "ì„ì§€ë¡œ4ê°€", "ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›", "ì‹ ë‹¹", "ìƒì™•ì‹­ë¦¬", "ì™•ì‹­ë¦¬", "í•œì–‘ëŒ€", "ëšì„¬", "ì„±ìˆ˜", "ê±´ëŒ€ì…êµ¬", "êµ¬ì˜", "ê°•ë³€", "ì ì‹¤ë‚˜ë£¨", "ì ì‹¤", "ì ì‹¤ìƒˆë‚´", "ì¢…í•©ìš´ë™ì¥", "ì‚¼ì„±", "ì„ ë¦‰", "ì—­ì‚¼", "ê°•ë‚¨", "êµëŒ€", "ì„œì´ˆ", "ë°©ë°°", "ì‚¬ë‹¹", "ì„œìš¸ëŒ€ì…êµ¬", "ë´‰ì²œ", "ì‹ ë¦¼", "ì‹ ëŒ€ë°©", "êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€", "ëŒ€ë¦¼", "ì‹ ë„ë¦¼", "ë¬¸ë˜", "ì˜ë“±í¬êµ¬ì²­", "ë‹¹ì‚°", "í•©ì •", "í™ëŒ€ì…êµ¬", "ì‹ ì´Œ", "ì´ëŒ€", "ì•„í˜„", "ì¶©ì •ë¡œ"],
  "2í˜¸ì„ _ì„±ìˆ˜ì§€ì„ ": ["ì„±ìˆ˜", "ìš©ë‹µ", "ì‹ ë‹µ", "ìš©ë‘", "ì‹ ì„¤ë™"],
  "2í˜¸ì„ _ì‹ ë„ë¦¼ì§€ì„ ": ["ì‹ ë„ë¦¼", "ë„ë¦¼ì²œ", "ì–‘ì²œêµ¬ì²­", "ì‹ ì •ë„¤ê±°ë¦¬", "ê¹Œì¹˜ì‚°"],
  
  "3í˜¸ì„ ": ["ëŒ€í™”", "ì£¼ì—½", "ì •ë°œì‚°", "ë§ˆë‘", "ë°±ì„", "ëŒ€ê³¡", "í™”ì •", "ì›ë‹¹", "ì›í¥", "ì‚¼ì†¡", "ì§€ì¶•", "êµ¬íŒŒë°œ", "ì—°ì‹ ë‚´", "ë¶ˆê´‘", "ë…¹ë²ˆ", "í™ì œ", "ë¬´ì•…ì¬", "ë…ë¦½ë¬¸", "ê²½ë³µê¶", "ì•ˆêµ­", "ì¢…ë¡œ3ê°€", "ì„ì§€ë¡œ3ê°€", "ì¶©ë¬´ë¡œ", "ë™ëŒ€ì…êµ¬", "ì•½ìˆ˜", "ê¸ˆí˜¸", "ì˜¥ìˆ˜", "ì••êµ¬ì •", "ì‹ ì‚¬", "ì ì›", "ê³ ì†í„°ë¯¸ë„", "êµëŒ€", "ë‚¨ë¶€í„°ë¯¸ë„", "ì–‘ì¬", "ë§¤ë´‰", "ë„ê³¡", "ëŒ€ì¹˜", "í•™ì—¬ìš¸", "ëŒ€ì²­", "ì¼ì›", "ìˆ˜ì„œ", "ê°€ë½ì‹œì¥", "ê²½ì°°ë³‘ì›", "ì˜¤ê¸ˆ"],
  
  "4í˜¸ì„ ": ["ë‹¹ê³ ê°œ", "ìƒê³„", "ë…¸ì›", "ì°½ë™", "ìŒë¬¸", "ìˆ˜ìœ ", "ë¯¸ì•„", "ë¯¸ì•„ì‚¬ê±°ë¦¬", "ê¸¸ìŒ", "ì„±ì‹ ì—¬ëŒ€ì…êµ¬", "í•œì„±ëŒ€ì…êµ¬", "í˜œí™”", "ë™ëŒ€ë¬¸", "ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›", "ì¶©ë¬´ë¡œ", "ëª…ë™", "íšŒí˜„", "ì„œìš¸", "ìˆ™ëŒ€ì…êµ¬", "ì‚¼ê°ì§€", "ì‹ ìš©ì‚°", "ì´ì´Œ", "ë™ì‘", "ì´ì‹ ëŒ€ì…êµ¬", "ì‚¬ë‹¹", "ë‚¨íƒœë ¹"],
  
  "5í˜¸ì„ _í•˜ë‚¨": ["ë°©í™”", "ê°œí™”ì‚°", "ê¹€í¬ê³µí•­", "ì†¡ì •", "ë§ˆê³¡", "ë°œì‚°", "ìš°ì¥ì‚°", "í™”ê³¡", "ê¹Œì¹˜ì‚°", "ì‹ ì •", "ëª©ë™", "ì˜¤ëª©êµ", "ì–‘í‰", "ì˜ë“±í¬êµ¬ì²­", "ì˜ë“±í¬ì‹œì¥", "ì‹ ê¸¸", "ì—¬ì˜ë„", "ì—¬ì˜ë‚˜ë£¨", "ë§ˆí¬", "ê³µë•", "ì• ì˜¤ê°œ", "ì¶©ì •ë¡œ", "ì„œëŒ€ë¬¸", "ê´‘í™”ë¬¸", "ì¢…ë¡œ3ê°€", "ì„ì§€ë¡œ4ê°€", "ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›", "ì²­êµ¬", "ì‹ ê¸ˆí˜¸", "í–‰ë‹¹", "ì™•ì‹­ë¦¬", "ë§ˆì¥", "ë‹µì‹­ë¦¬", "ì¥í•œí‰", "êµ°ì", "ì•„ì°¨ì‚°", "ê´‘ë‚˜ë£¨", "ì²œí˜¸", "ê°•ë™", "ê¸¸ë™", "êµ½ì€ë‹¤ë¦¬", "ëª…ì¼", "ê³ ë•", "ìƒì¼ë™", "ê°•ì¼", "ë¯¸ì‚¬", "í•˜ë‚¨í’ì‚°", "í•˜ë‚¨ì‹œì²­", "í•˜ë‚¨ê²€ë‹¨ì‚°"],
  "5í˜¸ì„ _ë§ˆì²œ": ["ê°•ë™", "ë‘”ì´Œë™", "ì˜¬ë¦¼í”½ê³µì›", "ë°©ì´", "ì˜¤ê¸ˆ", "ê°œë¡±", "ê±°ì—¬", "ë§ˆì²œ"],

"6í˜¸ì„ ": [
    "ì‹ ë‚´","ë´‰í™”ì‚°", "í™”ë‘ëŒ€", "íƒœë¦‰ì…êµ¬", "ì„ê³„", "ëŒê³¶ì´", "ìƒì›”ê³¡", "ì›”ê³¡",
    "ê³ ë ¤ëŒ€", "ì•ˆì•”", "ë³´ë¬¸", "ì°½ì‹ ", "ë™ë¬˜ì•", "ì‹ ë‹¹", "ì²­êµ¬", "ì•½ìˆ˜", "ë²„í‹°ê³ ê°œ",
    "í•œê°•ì§„", "ì´íƒœì›", "ë…¹ì‚¬í‰", "ì‚¼ê°ì§€", "íš¨ì°½ê³µì›ì•", "ê³µë•", "ëŒ€í¥", "ê´‘í¥ì°½", "ìƒìˆ˜", "í•©ì •",
    "ë§ì›", "ë§ˆí¬êµ¬ì²­", "ì›”ë“œì»µê²½ê¸°ì¥", "ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°", "ì¦ì‚°", "ìƒˆì ˆ",
    "ì‘ì•”", "ì—­ì´Œ", "ë¶ˆê´‘", "ë…ë°”ìœ„", "ì—°ì‹ ë‚´", "êµ¬ì‚°", "ì‘ì•”"
],
  
  "7í˜¸ì„ ": ["ì¥ì•”", "ë„ë´‰ì‚°", "ìˆ˜ë½ì‚°", "ë§ˆë“¤", "ë…¸ì›", "ì¤‘ê³„", "í•˜ê³„", "ê³µë¦‰", "íƒœë¦‰ì…êµ¬", "ë¨¹ê³¨", "ì¤‘í™”", "ìƒë´‰", "ë©´ëª©", "ì‚¬ê°€ì •", "ìš©ë§ˆì‚°", "ì¤‘ê³¡", "êµ°ì", "ì–´ë¦°ì´ëŒ€ê³µì›", "ê±´ëŒ€ì…êµ¬", "ëšì„¬ìœ ì›ì§€", "ì²­ë‹´", "ê°•ë‚¨êµ¬ì²­", "í•™ë™", "ë…¼í˜„", "ë°˜í¬", "ê³ ì†í„°ë¯¸ë„", "ë‚´ë°©", "ì´ìˆ˜", "ë‚¨ì„±", "ìˆ­ì‹¤ëŒ€ì…êµ¬", "ìƒë„", "ì¥ìŠ¹ë°°ê¸°", "ì‹ ëŒ€ë°©ì‚¼ê±°ë¦¬", "ë³´ë¼ë§¤", "ì‹ í’", "ëŒ€ë¦¼", "ë‚¨êµ¬ë¡œ", "ê°€ì‚°ë””ì§€í„¸ë‹¨ì§€", "ì² ì‚°", "ê´‘ëª…ì‚¬ê±°ë¦¬", "ì²œì™•", "ì˜¨ìˆ˜", "ê¹Œì¹˜ìš¸", "ë¶€ì²œì¢…í•©ìš´ë™ì¥", "ì¶˜ì˜", "ì‹ ì¤‘ë™", "ë¶€ì²œì‹œì²­", "ìƒë™", "ì‚¼ì‚°ì²´ìœ¡ê´€", "êµ´í¬ì²œ", "ë¶€í‰êµ¬ì²­", "ì‚°ê³¡", "ì„ë‚¨", "ì„œë¶€ì—¬ì„±íšŒê´€", "ë‚¨ë¶€ì‹œì¥", "ì˜¨ìˆ˜"],
  
  "8í˜¸ì„ ": ["ì•”ì‚¬", "ì²œí˜¸", "ê°•ë™êµ¬ì²­", "ëª½ì´Œí† ì„±", "ì ì‹¤", "ì„ì´Œ", "ì†¡íŒŒ", "ê°€ë½ì‹œì¥", "ë¬¸ì •", "ì¥ì§€", "ë³µì •", "ë‚¨ìœ„ë¡€", "ì‚°ì„±", "ë‚¨í•œì‚°ì„±ì…êµ¬", "ë‹¨ëŒ€ì˜¤ê±°ë¦¬", "ì‹ í¥", "ìˆ˜ì§„", "ëª¨ë€"]
};

async function loadStationsAndDraw() {
    const response = await fetch("/api/stations");
    const stations = await response.json();

    const stationMap = {};
    stations.forEach(s => {
        stationMap[s["ì—­ëª…"]] = s;
    });

    map = L.map("map").setView([37.5665, 126.9780], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ì—­ ë§ˆì»¤
    Object.values(stationMap).forEach(station => {
        const color = lineColors[station["í˜¸ì„ ëª…"]] || "gray";
        L.circleMarker([station["ìœ„ë„"], station["ê²½ë„"]], {
            radius: 4,
            color: color,
            fillColor: color,
            fillOpacity: 0.8
        }).bindPopup(`${station["í˜¸ì„ ëª…"]} ${station["ì—­ëª…"]}`).addTo(map);
    });

    // ì„ ë¡œ ê·¸ë¦¬ê¸°
    for (const [line, orderedNames] of Object.entries(manualOrders)) {
        const coords = orderedNames
            .map(name => stationMap[name])
            .filter(Boolean)
            .map(s => [s["ìœ„ë„"], s["ê²½ë„"]]);

        const baseLine = line.replace(/_.*$/, "");  // "5í˜¸ì„ _í•˜ë‚¨" â†’ "5í˜¸ì„ "
        const color = lineColors[baseLine] || "gray";
        L.polyline(coords, {
            color: color,
            weight: 3,
            opacity: 0.6
        }).addTo(map);
    }
}

function animateMove(marker, fromLatLng, toLatLng, duration = 1000) {
    const start = performance.now();

    function step(timestamp) {
        const progress = Math.min((timestamp - start) / duration, 1);
        const lat = fromLatLng.lat + (toLatLng.lat - fromLatLng.lat) * progress;
        const lng = fromLatLng.lng + (toLatLng.lng - fromLatLng.lng) * progress;
        marker.setLatLng([lat, lng]);

        if (progress < 1) {
            requestAnimationFrame(step);
        }
    }

    requestAnimationFrame(step);
}

async function updateTrainMarkers() {
    const response = await fetch("/api/trains");
    const trains = await response.json();

    trains.forEach(train => {
        const key = train.trainNo;
        const latlng = L.latLng(train.lat, train.lon);
        const color = lineColors[train.line.replace(/_.*$/, "")] || "gray";

        if (trainMarkers[key]) {
            const currentLatLng = trainMarkers[key].getLatLng();
            animateMove(trainMarkers[key], currentLatLng, latlng);
        } else {
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    html: `<i class="fas fa-train" style="color:${color};"></i>`,
                    className: `train-icon-${train.line}`,
                    iconSize: [20, 20]
                })
            }).bindPopup(`ğŸš†${train.trainNo}<br>${train.line} ${train.station}<br>â†’ ${train.dest}<br>ìƒíƒœ: ${train.status}`);
            marker.addTo(map);
            trainMarkers[key] = marker;
        }
    });
}

loadStationsAndDraw().then(() => {
    updateTrainMarkers();
    setInterval(updateTrainMarkers, 7000);
});